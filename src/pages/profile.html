<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª - Clean Quarter</title>
    
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 56px;
        }
        
        .navbar {
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 1000;
        }
        
        .profile-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }
        
        .profile-header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 600;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #212529;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #28a745;
        }
        
        .profile-info-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        
        .profile-info-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }
        
        .profile-info-value {
            color: #212529;
            font-size: 1rem;
        }
        
        .danger-zone {
            background-color: #fff5f5;
            border: 1px solid #f5c2c7;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .danger-zone-title {
            color: #dc3545;
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .danger-zone-text {
            color: #495057;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }
        
        .delete-account-btn {
            background-color: #dc3545;
            border-color: #dc3545;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .delete-account-btn:hover {
            background-color: #c82333;
            border-color: #bd2130;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .delete-account-btn:active {
            transform: translateY(0);
        }
        
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/src/pages/dashboard.html">
                <strong>–ß–∏—Å—Ç –ö–≤–∞—Ä—Ç–∞–ª</strong>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/src/pages/create-campaign.html">–ù–æ–≤–∞ –∫–∞–º–ø–∞–Ω–∏—è</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/src/pages/rewards.html">–ù–∞–≥—Ä–∞–¥–∏</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/src/pages/profile.html">–ü—Ä–æ—Ñ–∏–ª</a>
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-danger btn-sm" id="logoutBtn">–ò–∑–ª–∏–∑–∞–Ω–µ</button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Profile Content -->
    <div class="profile-container">
        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</span>
            </div>
        </div>

        <!-- Profile Content (Hidden Initially) -->
        <div id="profileContent" style="display: none;">
            <!-- Profile Header -->
            <div class="profile-header">
                <h1 id="userEmail">‚úâÔ∏è user@example.com</h1>
                <div class="profile-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="pointsBalance">0</span>
                        <span class="stat-label">–¢–æ—á–∫–∏</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="campaignsCount">0</span>
                        <span class="stat-label">–ö–∞–º–ø–∞–Ω–∏–∏</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="participationsCount">0</span>
                        <span class="stat-label">–£—á–∞—Å—Ç–∏—è</span>
                    </div>
                </div>
            </div>

            <!-- Account Settings Section -->
            <div class="settings-section">
                <h2 class="section-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞</h2>
                
                <div class="profile-info-row">
                    <div class="profile-info-label">–ò–º–µ–π–ª:</div>
                    <div class="profile-info-value" id="displayEmail">‚Äî</div>
                </div>
                
                <div class="profile-info-row">
                    <div class="profile-info-label">–ö–≤–∞—Ä—Ç–∞–ª:</div>
                    <div class="profile-info-value" id="displayNeighborhood">‚Äî</div>
                </div>
                
                <div class="profile-info-row">
                    <div class="profile-info-label">–¢–æ—á–∫–∏:</div>
                    <div class="profile-info-value" id="displayPoints">0</div>
                </div>
                
                <div class="profile-info-row">
                    <div class="profile-info-label">–°—Ç–∞—Ç—É—Å:</div>
                    <div class="profile-info-value">
                        <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="danger-zone">
                    <div class="danger-zone-title">‚ö†Ô∏è –û–ø–∞—Å–Ω–∞ –∑–æ–Ω–∞</div>
                    <div class="danger-zone-text">
                        –ò–∑—Ç—Ä–∏–≤–∞–Ω–µ—Ç–æ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞ –µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –¥–µ–π—Å—Ç–≤–∏–µ. –í—Å–∏—á–∫–∏ –≤–∞—à–∏ –¥–∞–Ω–Ω–∏, –≤–∫–ª—é—á–∏—Ç–µ–ª–Ω–æ –∫–∞–º–ø–∞–Ω–∏–∏, —É—á–∞—Å—Ç–∏—è –∏ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ —Ç–æ—á–∫–∏, —â–µ –±—ä–¥–∞—Ç –æ–∫–æ–Ω—á–∞—Ç–µ–ª–Ω–æ –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç–∏ –æ—Ç –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏.
                    </div>
                    <button class="btn delete-account-btn" id="deleteAccountBtn">
                        üóëÔ∏è –ò–∑—Ç—Ä–∏–π –ø—Ä–æ—Ñ–∏–ª
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Profile Script -->
    <script type="module">
        import supabase from '../services/supabase.js';
        import { logout } from '../services/auth.js';

        let currentUser = null;

        // Check if user is logged in
        window.addEventListener('DOMContentLoaded', async () => {
            const userJSON = localStorage.getItem('user');
            if (!userJSON) {
                window.location.href = '/index.html';
                return;
            }

            currentUser = JSON.parse(userJSON);
            await loadProfileData();
        });

        // Load profile data
        async function loadProfileData() {
            try {
                const loadingSpinner = document.getElementById('loadingSpinner');
                const profileContent = document.getElementById('profileContent');

                // Fetch user profile
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('username, neighborhood, points_balance')
                    .eq('id', currentUser.id)
                    .single();

                if (profileError) {
                    console.error('Error fetching profile:', profileError);
                    throw profileError;
                }

                // Fetch user campaigns count
                const { data: campaigns, error: campaignsError } = await supabase
                    .from('campaigns')
                    .select('id', { count: 'exact' })
                    .eq('created_by', currentUser.id);

                if (campaignsError) console.error('Error fetching campaigns:', campaignsError);

                // Fetch user participations count
                const { data: participations, error: participationsError } = await supabase
                    .from('participations')
                    .select('id', { count: 'exact' })
                    .eq('user_id', currentUser.id);

                if (participationsError) console.error('Error fetching participations:', participationsError);

                // Update UI
                document.getElementById('userEmail').textContent = `‚úâÔ∏è ${currentUser.email}`;
                document.getElementById('displayEmail').textContent = currentUser.email;
                document.getElementById('displayNeighborhood').textContent = profile?.neighborhood || '–ù–µ –µ –∑–∞–¥–∞–¥–µ–Ω–æ';
                document.getElementById('displayPoints').textContent = profile?.points_balance || 0;
                document.getElementById('pointsBalance').textContent = profile?.points_balance || 0;
                document.getElementById('campaignsCount').textContent = campaigns?.length || 0;
                document.getElementById('participationsCount').textContent = participations?.length || 0;

                // Hide loading spinner and show content
                loadingSpinner.style.display = 'none';
                profileContent.style.display = 'block';
            } catch (error) {
                console.error('Error loading profile data:', error);
                Swal.fire({
                    title: '–ì—Ä–µ—à–∫–∞',
                    text: '–ù–µ –º–æ–∂–∞—Ö–º–µ –¥–∞ –∑–∞—Ä–µ–∂–¥–∏–º –¥–∞–Ω–Ω–∏—Ç–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.',
                    icon: 'error',
                    confirmButtonColor: '#28a745'
                });
            }
        }

        // Delete Account Button Handler
        document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
            // First confirmation
            const result1 = await Swal.fire({
                title: '–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?',
                text: '–¢–æ–≤–∞ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –í—Å–∏—á–∫–∏ —Ç–≤–æ–∏ –¥–∞–Ω–Ω–∏ —â–µ –±—ä–¥–∞—Ç –∏–∑—Ç—Ä–∏—Ç–∏.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '–î–∞, –∏–∑—Ç—Ä–∏–π –ø—Ä–æ—Ñ–∏–ª–∞ –º–∏',
                cancelButtonText: '–û—Ç–∫–∞–∑'
            });

            if (!result1.isConfirmed) return;

            // Second confirmation with password verification
            const result2 = await Swal.fire({
                title: '–ü–æ—Ç–≤—ä—Ä–¥–∏ —Å –∏–º–µ–π–ª',
                text: '–ó–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç, –º–æ–ª—è –ø–æ—Ç–≤—ä—Ä–¥–∏ —Å—ä—Å —Å–≤–æ—è –∏–º–µ–π–ª –∞–¥—Ä–µ—Å:',
                input: 'email',
                inputValue: currentUser.email,
                inputAttributes: {
                    autocapitalize: 'off',
                    autocorrect: 'off'
                },
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: '–î–∞, –∏–∑—Ç—Ä–∏–π –≤—Å–∏—á–∫–æ',
                cancelButtonText: '–û—Ç–∫–∞–∑',
                inputValidator: (value) => {
                    if (value !== currentUser.email) {
                        return '–ò–º–µ–π–ª—ä—Ç –Ω–µ —Å—ä–æ—Ç–≤–µ—Ç—Å—Ç–≤–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–∏—è.';
                    }
                }
            });

            if (!result2.isConfirmed) return;

            // Perform deletion
            await deleteUserAccount();
        });

        // Delete user account and all related data
        async function deleteUserAccount() {
            try {
                // Show loading
                Swal.fire({
                    title: '–ò–∑—Ç—Ä–∏–≤–∞–º –ø—Ä–æ—Ñ–∏–ª–∞...',
                    icon: 'info',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const userId = currentUser.id;

                // 1. Delete participations
                const { error: partError } = await supabase
                    .from('participations')
                    .delete()
                    .eq('user_id', userId);

                if (partError) throw new Error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ —É—á–∞—Å—Ç–∏—è: ' + partError.message);

                // 2. Delete campaigns (will cascade delete related participations if any)
                const { error: campaignError } = await supabase
                    .from('campaigns')
                    .delete()
                    .eq('created_by', userId);

                if (campaignError) throw new Error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∫–∞–º–ø–∞–Ω–∏–∏: ' + campaignError.message);

                // 3. Delete point transactions
                const { error: transError } = await supabase
                    .from('point_transactions')
                    .delete()
                    .eq('user_id', userId);

                if (transError) throw new Error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è: ' + transError.message);

                // 4. Delete profile
                const { error: profileError } = await supabase
                    .from('profiles')
                    .delete()
                    .eq('id', userId);

                if (profileError) throw new Error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–∞: ' + profileError.message);

                // 5. Sign out from Supabase Auth
                const { error: signoutError } = await supabase.auth.signOut();
                if (signoutError) console.warn('Signout warning:', signoutError);

                // Clear local storage
                localStorage.removeItem('user');

                // Success message
                await Swal.fire({
                    title: '–ü—Ä–æ—Ñ–∏–ª—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç',
                    text: '–í—Å–∏—á–∫–∏ —Ç–≤–æ–∏ –¥–∞–Ω–Ω–∏ —Å–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–º–∞—Ö–Ω–∞—Ç–∏. –©–µ –±—ä–¥–µ—à –ø—Ä–µ–Ω–∞—Å–æ—á–µ–Ω –∫—ä–º –Ω–∞—á–∞–ª–Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞.',
                    icon: 'success',
                    confirmButtonColor: '#28a745'
                });

                // Redirect to home
                window.location.href = '/index.html';
            } catch (error) {
                console.error('Error deleting account:', error);
                Swal.fire({
                    title: '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç—Ä–∏–≤–∞–Ω–µ',
                    text: error.message || '–ù–µ –º–æ–∂–∞—Ö–º–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ–º –ø—Ä–æ—Ñ–∏–ª–∞. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ –ø–æ-–∫—ä—Å–Ω–æ.',
                    icon: 'error',
                    confirmButtonColor: '#28a745'
                });
            }
        }

        // Logout button handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await logout();
                localStorage.removeItem('user');
                window.location.href = '/index.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });
    </script>
</body>
</html>
